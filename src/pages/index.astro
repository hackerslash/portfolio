---
import Layout from "@/layouts/Layout.astro"
import { basics, work, education, skills } from "@cv"

import About from "@/components/sections/About.astro"
import Education from "@/components/sections/Education.astro"
import Experience from "@/components/sections/Experience.astro"
import Hero from "@/components/sections/Hero.astro"
import Projects from "@/components/sections/Projects.astro"
import Skills from "@/components/sections/Skills.astro"
import Blogs from "@/components/sections/Blogs.astro"

const currentYear = new Date().getFullYear()

// SEO optimized title and description
const pageTitle = "Md Afridi Sk | Backend Developer & Full Stack Engineer | IIT Kharagpur"
const pageDescription = "Md Afridi Sk - Backend Developer based in Bangalore, India. IIT Kharagpur graduate specializing in Python, Node.js, React, and AI. Building scalable applications at Ayoo.care. View projects, skills, and technical blog."

// JSON-LD Structured Data for Person + WebSite
const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": `${basics.url}/#website`,
      "url": basics.url,
      "name": "Md Afridi Sk - Portfolio",
      "description": pageDescription,
      "publisher": {
        "@id": `${basics.url}/#person`
      },
      "inLanguage": "en-US"
    },
    {
      "@type": "ProfilePage",
      "@id": `${basics.url}/#profilepage`,
      "url": basics.url,
      "name": pageTitle,
      "isPartOf": {
        "@id": `${basics.url}/#website`
      },
      "about": {
        "@id": `${basics.url}/#person`
      },
      "description": pageDescription,
      "inLanguage": "en-US"
    },
    {
      "@type": "Person",
      "@id": `${basics.url}/#person`,
      "name": basics.name,
      "alternateName": "hackerslash",
      "url": basics.url,
      "image": {
        "@type": "ImageObject",
        "url": `${basics.url}/profile-pic.png`,
        "width": 400,
        "height": 400
      },
      "description": basics.summary,
      "email": `mailto:${basics.email}`,
      "telephone": basics.phone,
      "jobTitle": basics.label,
      "worksFor": {
        "@type": "Organization",
        "name": work[0].name,
        "url": work[0].url
      },
      "alumniOf": {
        "@type": "CollegeOrUniversity",
        "name": education[0].institution,
        "url": "https://www.iitkgp.ac.in"
      },
      "address": {
        "@type": "PostalAddress",
        "addressLocality": basics.location.city,
        "addressRegion": basics.location.region,
        "addressCountry": basics.location.countryCode
      },
      "sameAs": [
        basics.profiles.find(p => p.network === "GitHub")?.url,
        basics.profiles.find(p => p.network === "LinkedIn")?.url
      ].filter(Boolean),
      "knowsAbout": skills.map(s => s.name)
    }
  ]
}
---

<Layout
  title={pageTitle}
  description={pageDescription}
  jsonLd={jsonLd}
>
  <main>
    <Hero />
    <About />
    <Experience />
    <Education />
    <Projects />
    <Skills />
    <Blogs />
  </main>

  <footer class="no-print">
    <p>¬© {currentYear} Md Afridi Sk - Made with ‚ù§Ô∏è</p>
    <div class="visitor-counter">
      <span class="counter-icon">üëÅÔ∏è</span>
      <span id="visitor-count">‚Äî</span>
      <span class="counter-label">visitors</span>
    </div>
  </footer>
</Layout>

<script is:inline>
  // Fetch total visitor count from GoatCounter JSON API with retry logic
  (function() {
    var el = document.getElementById('visitor-count');
    if (!el) return;

    var maxRetries = 2;
    var retryDelay = 3000; // 3 seconds
    var attemptCount = 0;

    function fetchVisitorCount() {
      attemptCount++;

      fetch('https://hackerslash.goatcounter.com/counter/TOTAL.json')
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to fetch');
          return response.json();
        })
        .then(function(data) {
          if (data && data.count !== undefined) {
            el.textContent = data.count_unique || data.count || '0';
            el.style.color = 'var(--accent-color)';
          } else {
            throw new Error('Invalid data');
          }
        })
        .catch(function(error) {
          console.warn('Visitor count fetch attempt ' + attemptCount + ' failed:', error);

          if (attemptCount < maxRetries) {
            // Show loading state and retry
            el.textContent = '...';
            el.style.color = 'var(--text-muted)';
            setTimeout(fetchVisitorCount, retryDelay);
          } else {
            // All retries failed
            el.textContent = 'N/A';
            el.style.color = 'var(--text-muted)';
            el.title = 'Unable to load visitor count';
          }
        });
    }

    // Initial loading state
    el.textContent = '...';
    el.style.color = 'var(--text-muted)';

    // Start fetching
    fetchVisitorCount();
  })();
</script>

<style>
  main {
    padding: 4rem;
    margin: auto;
    width: 100%;
  }

  footer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 2rem;
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  .visitor-counter {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.8rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    font-size: 0.75rem;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  .visitor-counter:hover {
    opacity: 1;
  }

  .counter-icon {
    font-size: 0.85rem;
  }

  #visitor-count {
    font-weight: 600;
    color: var(--accent-color);
  }

  .counter-label {
    color: var(--text-muted);
  }

  /* Mobile landscape optimizations */
  @media (max-height: 500px) and (orientation: landscape) {
    main {
      padding: 2rem;
    }

    footer {
      padding: 1rem;
    }
  }

  @media (width <= 700px) {
    main {
      padding: 1.5rem;
    }
  }
</style>
